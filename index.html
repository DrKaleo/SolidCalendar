<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* These variables are now controlled by the Theme Modal */
    :root {
      --outer-bg: #4a6741;
      --inner-bg: #0b2612;
      --tile-bg: #1c3d25;
      --text-primary: #75a478;
      --danger: #8b2e2e;
      --grid-gap: 8px;

      /* Class Type Colors */
      --c-starter: #78a2cc;
      --c-foundation: #a2cc78;
      --c-signature: #75a478;
      --c-focus: #ccae78;
      --c-power: #cc7878;
      --c-advanced: #b378cc;

      --t-starter: #ffffff;
      --t-foundation: #ffffff;
      --t-signature: #ffffff;
      --t-focus: #ffffff;
      --t-power: #ffffff;
      --t-advanced: #ffffff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--outer-bg);
      font-family: 'Merriweather', serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
    }

    .controls {
      width: 100%;
      max-width: 850px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .selectors {
      display: flex;
      gap: 10px;
    }

    select.nav-select,
    .theme-btn {
      background: var(--inner-bg);
      color: var(--text-primary);
      border: 1px solid var(--text-primary);
      padding: 5px 10px;
      font-family: 'Merriweather', serif;
      cursor: pointer;
    }

    .add-btn {
      background-color: var(--tile-bg);
      color: var(--text-primary);
      border: 1px solid var(--text-primary);
      padding: 10px 20px;
      cursor: pointer;
    }

    .calendar-container {
      width: 100%;
      max-width: 850px;
      background-color: var(--inner-bg);
      padding: 20px;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .header h1 {
      font-size: 2.2rem;
      font-weight: normal;
      text-transform: uppercase;
    }

  .dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    background-color: var(--inner-bg);
    min-width: 200px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.5);
    z-index: 1002;
    border: 1px solid var(--text-primary);
    margin-top: 5px;
  }

  .dropdown-content button {
    color: var(--text-primary);
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    width: 100%;
    text-align: left;
    background: none;
    border: none;
    font-family: inherit;
    font-size: 0.85rem;
    cursor: pointer;
  }

    .dropdown-content button:hover {
      background-color: var(--tile-bg);
    }

    .dropdown.open .caret {
      transform: rotate(180deg);
    }

    /* The Caret (Triangle) */
    .caret {
      display: inline-block;
      width: 0;
      height: 0;
      margin-left: 8px;
      vertical-align: middle;
      border-top: 5px solid; /* This uses the current text color */
      border-right: 5px solid transparent;
      border-left: 5px solid transparent;
      transition: transform 0.2s ease;
    }

  /* Rotate the caret when the menu is open */
    .show + .dropdown-toggle .caret, 
    .dropdown-toggle:active .caret {
      transform: rotate(180deg);
    }

    .dropdown-toggle {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .show { display: block; }

    .dropdown.open .dropdown-toggle {
      background-color: var(--tile-bg);
      border-color: var(--text-primary);
    }

    .line {
      height: 1px;
      background-color: var(--text-primary);
      flex-grow: 1;
    }

    .main-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: var(--grid-gap);
    }

    .weekday-label {
      color: var(--text-primary);
      font-size: 1.8rem;
      text-align: center;
      padding: 10px 0;
    }

    .day {
      background: var(--inner-bg);
      border: 1px solid color-mix(in srgb, var(--text-primary) 20%, transparent);
      border-radius: 12px;
      min-height: 120px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .day-header {
      font-size: 0.65rem;
      letter-spacing: 1px;
      opacity: 0.7;
      text-align: right;
    }
    .class-entry {
      background: var(--tile-bg);
      border-radius: 10px;
      padding: 8px 8px 14px;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 4px;
      box-shadow:
        0 1px 2px rgba(0,0,0,0.2),
        inset 0 0 0 1px rgba(255,255,255,0.04);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .class-entry:hover {
      transform: translateY(-2px);
      box-shadow:
        0 4px 10px rgba(0,0,0,0.35),
        inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    .class-entry .title {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .class-entry .details {
      font-size: 0.6rem;
      opacity: 0.85;
      line-height: 1.3;
    }
    .focus-text {
      font-size: 0.75rem;
      opacity: 0.75;
      line-height: 1.2;
    }

    .day.active {
      background-color: var(--tile-bg);
      padding: 5px;
      cursor: pointer;
      transition: 0.1s;
      border: 1px solid transparent;
    }

    .day.active:hover {
      transform: scale(1.02);
      z-index: 5;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      border-color: var(--text-primary);
    }

    .date-num {
      position: relative;
      font-size: 1.25rem;
      font-family: Arial, sans-serif;
      color: var(--text-primary);
    }

    .details {
      font-size: 0.75rem;
      font-family: Arial, sans-serif;
      line-height: 1.2;
      margin-top: 2px;
      color: var(--text-primary);
    }

    .box {
      border: 1px solid var(--text-primary);
      margin-top: 4px;
      padding: 6px 4px;
      gap: 3px;
      border-radius: 4px;
      text-align: center;
      height: auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
      position:relative;
      color: var(--text-primary);
      overflow: hidden;
      text-shadow: 0px 1px 2px rgba(0,0,0,0.3);
    }
    



    .box.Starter50    { background-color: var(--c-starter); color: var(--t-starter); }
    .box.Foundation50 { background-color: var(--c-foundation); color: var(--t-foundation); }
    .box.Signature50  { background-color: var(--c-signature); color: var(--t-signature); }
    .box.Focus50      { background-color: var(--c-focus); color: var(--t-focus); }
    .box.Power30      { background-color: var(--c-power); color: var(--t-power); }
    .box.Advanced50, 
    .box.Advanced65   { background-color: var(--c-advanced); color: var(--t-advanced); }
 
    .box .title, .box .focus-text { color: inherit; }

    .title {
      font-weight: bold;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: var(--inner-bg);
      border: 2px solid var(--text-primary);
      padding: 25px;
      min-width: 480px;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.7rem;
      margin-bottom: 3px;
      text-transform: uppercase;
      opacity: 0.8;
    }

    .form-group input,
    .form-group select {
      background: var(--tile-bg);
      border: 1px solid var(--text-primary);
      color: var(--text-primary);
      padding: 8px;
    }

    .color-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .color-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
    }

    .color-item input {
      width: 40px;
      height: 30px;
      border: 1px solid var(--text-primary);
      cursor: pointer;
      background: none;
      padding: 0;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .modal-actions button {
      flex: 1;
      padding: 12px;
      cursor: pointer;
      border: 1px solid var(--text-primary);
      font-family: 'Merriweather', serif;
    }

    .theme-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .theme-badge {
      font-size: 0.55rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid;
      opacity: 0.85;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }


    .class-number {
      position: absolute;
      bottom: 2px;
      right: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      opacity: 0.6;
      line-height: 1; 
      pointer-events: none; 
    }
    .day.today {
      outline: 2px solid var(--text-primary);
      outline-offset: 2px;
    }
  </style>
</head>

<body>

  <div class="controls">
    <div class="selectors">
      <select id="view-month" class="nav-select" onchange="changeDate()"></select>
      <select id="view-year" class="nav-select" onchange="changeDate()"></select>
      <div class="dropdown">
        <button class="theme-btn dropdown-toggle" onclick="toggleDropdown()">‚öôÔ∏è Actions <span class="caret"></span></button>
        <div id="actionsMenu" class="dropdown-content">
          <button onclick="openClassOffsetPrompt()">üèÅ Set Lifetime Count</button>
          <button onclick="openThemeModal()">üé® Theme Settings</button>
          <hr style="border: 0; border-top: 1px solid var(--text-primary); opacity: 0.2; margin: 5px 0;">
          <button onclick="exportData()">üì§ Export Backup (.json)</button>
          <button onclick="document.getElementById('importFile').click()">üì• Import Backup</button>
        </div>
      </div>
      <input type="file" id="importFile" style="display:none" onchange="importData(event)" accept=".json">
    </div>
    <button class="add-btn" onclick="openAddModal()">+ Add New Class</button>
  </div>

  <div class="calendar-container">
    <div class="header">
      <div class="line"></div>
      <h1 id="display-month">JANUARY</h1>
      <div id="overall-count" style="
      font-size: 0.75rem;
      opacity: 0.85;
      letter-spacing: 1px;
    ">
        Classes Completed: 0
      </div>
      <div class="line"></div>
    </div>
    <div id="calendar-grid" class="main-grid"></div>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
      <h2 id="modalTitle" style="margin-bottom:15px; font-weight:normal;">Add New Class</h2>
      <form id="classForm">
        <input type="hidden" id="edit-id">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <div class="form-group"><label>Day</label><select id="m-day" required></select></div>
          <div class="form-group">
            <label>Class Type</label>
            <select id="m-name">
              <option value="Starter50">Starter50</option>
              <option value="Foundation50">Foundation50</option>
              <option value="Signature50" selected>Signature50</option>
              <option value="Focus50">Focus50</option>
              <option value="Power30">Power30</option>
              <option value="Advanced50">Advanced50</option>
              <option value="Advanced65">Advanced65</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="position:relative;">
          <label>Instructor</label>
          <input type="text" id="m-instructor" autocomplete="off" required>
          <div id="instructor-list" style="
          position:absolute;
          top:100%;
          left:0;
          right:0;
          background:var(--inner-bg);
          border:1px solid var(--text-primary);
          display:none;
          z-index:1001;
          max-height:150px;
          overflow-y:auto;
        "></div>
        </div>
        <div class="form-group">
          <label>Class Number (Auto-calculated)</label>
          <input type="text" id="m-class-num" readonly style="opacity: 0.6; cursor: not-allowed;"
            placeholder="Calculated on save...">
        </div>
        <div class="form-group"><label>Muscle Focuses</label>
          <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;" id="focus-container"></div>
        </div>
        <div class="form-group">
          <label>Class Themes</label>
          <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:6px;">
            <label><input type="checkbox" value="Music" class="theme-check"> Music</label>
            <label><input type="checkbox" value="Giveaway" class="theme-check"> Giveaway</label>
            <label><input type="checkbox" value="Pop Up" class="theme-check"> Pop Up</label>
            <label><input type="checkbox" value="Event" class="theme-check"> Event</label>
            <label><input type="checkbox" value="Team Teach" class="theme-check"> Team Teach</label>
            <label><input type="checkbox" value="Other" class="theme-check"> Other</label>
          </div>
        </div>
        <div class="form-group">
          <label>Theme Notes</label>
          <textarea id="m-theme-notes" rows="3"
            style="resize:none; background:var(--tile-bg); border:1px solid var(--text-primary); color:var(--text-primary);">
        </textarea>
        </div>
        <div style="display:flex; gap:10px;">
          <div class="form-group" style="flex:1;"><label>Start Time</label><input type="time" id="m-start" required>
          </div>
          <div class="form-group" style="flex:1;"><label>End Time</label><input type="time" id="m-end" required></div>
        </div>
        <div class="modal-actions">
          <button type="button" style="background:#8b2e2e; color:white; border:none; display:none;" id="deleteBtn"
            onclick="deleteEntry()">Delete</button>
          <button type="button" style="background:transparent; color:var(--text-primary)"
            onclick="closeModal()">Cancel</button>
          <button type="submit" style="background:var(--text-primary); color:var(--inner-bg); font-weight:bold;">Save
            Class</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-overlay" id="themeModal">
    <div class="modal-content" style="width: 550px; max-height: 90vh; overflow-y: auto;">
      <h2 style="margin-bottom:15px; font-weight:normal;">Customize Theme</h2>

      <label
        style="font-size: 0.7rem; text-transform: uppercase; opacity: 0.8; display: block; margin-bottom: 10px;">Preset
        Themes</label>
      <div id="preset-grid"
        style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 25px;">
      </div>

      <label
        style="font-size: 0.7rem; text-transform: uppercase; opacity: 0.8; display: block; margin-bottom: 10px;">Custom
        Colors</label>
      <div class="color-grid">
        <div class="color-item"><input type="color" id="p-outer"
            oninput="uiTheme('--outer-bg', this.value)"><label>Outer BG</label></div>
        <div class="color-item"><input type="color" id="p-inner"
            oninput="uiTheme('--inner-bg', this.value)"><label>Inner BG</label></div>
        <div class="color-item"><input type="color" id="p-tile" oninput="uiTheme('--tile-bg', this.value)"><label>Empty
            Tile</label></div>
        <div class="color-item"><input type="color" id="p-text"
            oninput="uiTheme('--text-primary', this.value)"><label>Text/Accents</label></div>

        <div style="grid-column: 1 / -1; height: 1px; background: var(--text-primary); opacity: 0.3; margin: 10px 0;">
        </div>

        <div class="color-item">
          <input type="color" id="p-starter" oninput="uiTheme('--c-starter', this.value)">
          <input type="color" id="pt-starter" oninput="uiTheme('--t-starter', this.value)">
            <label>Starter (BG/Text)</label></div>
        <div class="color-item"><input type="color" id="p-foundation" oninput="uiTheme('--c-foundation', this.value)">
            <input type="color" id="pt-foundation" oninput="uiTheme('--t-foundation', this.value)">
            <label>Foundation (BG/Text)</label></div>
        <div class="color-item"><input type="color" id="p-signature" oninput="uiTheme('--c-signature', this.value)">
            <input type="color" id="pt-signature" oninput="uiTheme('--t-signature', this.value)">
            <label>Signature (BG/Text)</label></div>
        <div class="color-item"><input type="color" id="p-focus" oninput="uiTheme('--c-focus', this.value)">
            <input type="color" id="pt-focus" oninput="uiTheme('--t-focus', this.value)">
            <label>Focus (BG/Text)</label></div>
        <div class="color-item"><input type="color" id="p-power" oninput="uiTheme('--c-power', this.value)">
            <input type="color" id="pt-power" oninput="uiTheme('--t-power', this.value)">
            <label>Power (BG/Text)</label></div>
        <div class="color-item"><input type="color" id="p-adv" oninput="uiTheme('--c-advanced', this.value)">
            <input type="color" id="pt-adv" oninput="uiTheme('--t-advanced', this.value)">
            <label>Advanced (BG/Text)</label></div>
      </div>

      <div class="modal-actions">
        <button type="button" style="background:var(--text-primary); color:var(--inner-bg); font-weight:bold;"
          onclick="closeThemeModal()">Done</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "classCalendarData_v1";
const INSTRUCTOR_KEY = "savedInstructors_v1";
const CLASS_OFFSET_KEY = "lifetimeClassOffset_v1";
const THEME_STORAGE_KEY = "calendarTheme_v1";

const THEME_VARS = [
  "--outer-bg", "--inner-bg", "--tile-bg", "--text-primary",
  "--c-starter", "--c-foundation", "--c-signature", "--c-focus", "--c-power", "--c-advanced",
  "--t-starter", "--t-foundation", "--t-signature", "--t-focus", "--t-power", "--t-advanced"
];

const CLASS_CONFIG = {
  "Starter50": 50,
  "Foundation50": 50,
  "Signature50": 50,
  "Focus50": 50,
  "Power30": 30,
  "Advanced50": 50,
  "Advanced65": 65
};

const THEMES = {
  "Signature": {
    outer: "#4a6741", inner: "#0b2612", tile: "#1c3d25", text: "#75a478",
    starter: "#78a2cc", foundation: "#a2cc78", signature: "#75a478", focus: "#ccae78", power: "#cc7878", advanced: "#b378cc",
    ts: "#ffffff", tf: "#0b2612", tsi: "#ffffff", tfo: "#0b2612", tp: "#ffffff", ta: "#ffffff"
  },
  "Midnight": {
    outer: "#1a1a1a", inner: "#000000", tile: "#262626", text: "#ffffff",
    starter: "#4a9eff", foundation: "#52c41a", signature: "#ffffff", focus: "#faad14", power: "#ff4d4f", advanced: "#722ed1",
    ts: "#ffffff", tf: "#ffffff", tsi: "#000000", tfo: "#000000", tp: "#ffffff", ta: "#ffffff"
  },
  "Oceanic": {
    outer: "#1e3a5f", inner: "#0d1b2a", tile: "#1b263b", text: "#a2d2ff",
    starter: "#48cae4", foundation: "#90be6d", signature: "#00b4d8", focus: "#ffd166", power: "#ef476f", advanced: "#be95ff",
    ts: "#0d1b2a", tf: "#0d1b2a", tsi: "#ffffff", tfo: "#0d1b2a", tp: "#ffffff", ta: "#ffffff"
  },
  "Espresso": {
    outer: "#3d2b1f", inner: "#1a0f0a", tile: "#2b1d16", text: "#d4a373",
    starter: "#a5a58d", foundation: "#bcbd8b", signature: "#d4a373", focus: "#ddbea9", power: "#cb997e", advanced: "#b7b7a4",
    ts: "#1a0f0a", tf: "#1a0f0a", tsi: "#1a0f0a", tfo: "#1a0f0a", tp: "#ffffff", ta: "#1a0f0a"
  },
  "Slate": {
    outer: "#4a5568", inner: "#1a202c", tile: "#2d3748", text: "#a0aec0",
    starter: "#63b3ed", foundation: "#68d391", signature: "#a0aec0", focus: "#f6ad55", power: "#fc8181", advanced: "#b794f4",
    ts: "#ffffff", tf: "#1a202c", tsi: "#1a202c", tfo: "#1a202c", tp: "#ffffff", ta: "#ffffff"
  },
  "Plum": {
    outer: "#4a2c4a", inner: "#2d162d", tile: "#3d1f3d", text: "#d6bcfa",
    starter: "#9f7aea", foundation: "#fbb6ce", signature: "#d6bcfa", focus: "#faf089", power: "#f56565", advanced: "#ed64a6",
    ts: "#ffffff", tf: "#2d162d", tsi: "#2d162d", tfo: "#2d162d", tp: "#ffffff", ta: "#ffffff"
  },
  "Crimson": {
    outer: "#63171b", inner: "#2d0a0c", tile: "#441013", text: "#feb2b2",
    starter: "#fbd38d", foundation: "#9ae6b4", signature: "#feb2b2", focus: "#faf089", power: "#fff5f5", advanced: "#e9d8fd",
    ts: "#2d0a0c", tf: "#2d0a0c", tsi: "#2d0a0c", tfo: "#2d0a0c", tp: "#2d0a0c", ta: "#2d0a0c"
  },
  "Forest": {
    outer: "#2d4a22", inner: "#14260f", tile: "#1e3617", text: "#9ae6b4",
    starter: "#81e6d9", foundation: "#c6f6d5", signature: "#9ae6b4", focus: "#fefcbf", power: "#feb2b2", advanced: "#d6bcfa",
    ts: "#14260f", tf: "#14260f", tsi: "#14260f", tfo: "#14260f", tp: "#14260f", ta: "#14260f"
  },
  "Desert": {
    outer: "#744210", inner: "#2d1a05", tile: "#432808", text: "#f6e05e",
    starter: "#fbd38d", foundation: "#c6f6d5", signature: "#f6e05e", focus: "#fff5f5", power: "#fc8181", advanced: "#e9d8fd",
    ts: "#2d1a05", tf: "#2d1a05", tsi: "#2d1a05", tfo: "#2d1a05", tp: "#ffffff", ta: "#2d1a05"
  },
  "Charcoal": {
    outer: "#2d3748", inner: "#171923", tile: "#2d3748", text: "#cbd5e0",
    starter: "#bee3f8", foundation: "#c6f6d5", signature: "#cbd5e0", focus: "#feebc8", power: "#fed7d7", advanced: "#e9d8fd",
    ts: "#171923", tf: "#171923", tsi: "#171923", tfo: "#171923", tp: "#171923", ta: "#171923"
  },
  "Rose": {
    outer: "#702459", inner: "#320923", tile: "#4d163d", text: "#fbb6ce",
    starter: "#f6ad55", foundation: "#9ae6b4", signature: "#fbb6ce", focus: "#faf089", power: "#fc8181", advanced: "#d6bcfa",
    ts: "#ffffff", tf: "#320923", tsi: "#320923", tfo: "#320923", tp: "#ffffff", ta: "#ffffff"
  },
  "Classic": {
    outer: "#2c5282", inner: "#1a365d", tile: "#2a4365", text: "#ebf8ff",
    starter: "#90cdf4", foundation: "#9ae6b4", signature: "#ebf8ff", focus: "#faf089", power: "#feb2b2", advanced: "#e9d8fd",
    ts: "#1a365d", tf: "#1a365d", tsi: "#1a365d", tfo: "#1a365d", tp: "#1a365d", ta: "#1a365d"
  }
};

const months = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

let classData = [];
let savedInstructors = [];
let classOffset = 0;

let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

// -=-=-=-=-=-=-=- Theme Logic -=-=-=-=-=-=-=-
  function uiTheme(variable, val) {
    document.documentElement.style.setProperty(variable, val);
    saveThemeToStorage();
  }

  function applyPreset(name) {
    const t = THEMES[name];
    if (!t) return;

    // Basic Theme Colors
    uiTheme('--outer-bg', t.outer);
    uiTheme('--inner-bg', t.inner);
    uiTheme('--tile-bg', t.tile);
    uiTheme('--text-primary', t.text);

    // Class Type Colors (Only apply if they exist in the preset)
    if (t.starter) {
      // Class Backgrounds
      uiTheme('--c-starter', t.starter);
      uiTheme('--c-foundation', t.foundation);
      uiTheme('--c-signature', t.signature);
      uiTheme('--c-focus', t.focus);
      uiTheme('--c-power', t.power);
      uiTheme('--c-advanced', t.advanced);

      // Class Text Colors
      uiTheme('--t-starter', t.ts);
      uiTheme('--t-foundation', t.tf);
      uiTheme('--t-signature', t.tsi);
      uiTheme('--t-focus', t.tfo);
      uiTheme('--t-power', t.tp);
      uiTheme('--t-advanced', t.ta);
    }

    // Keep the color pickers in the modal updated
    syncThemePickers();
  }

  function saveThemeToStorage() {
    const theme = {};
    const styles = getComputedStyle(document.documentElement);

    THEME_VARS.forEach(v => {
      theme[v] = styles.getPropertyValue(v).trim();
    });

    // Save using the month-specific key
    localStorage.setItem(getThemeKey(), JSON.stringify(theme));
  }
  function getThemeKey() {
    return `calendarTheme_${currentYear}_${currentMonth}`;
  }

  function loadThemeFromStorage() {
    const saved = localStorage.getItem(getThemeKey());
    
    // If no specific theme for this month exists, you can either 
    // do nothing (keep default) or load a "Global" default.
    if (!saved) {
      // Optional: Reset to default Signature theme if no month theme is found
      // applyPreset("Signature"); 
      return;
    }

    try {
      const theme = JSON.parse(saved);
      Object.entries(theme).forEach(([key, val]) => {
        document.documentElement.style.setProperty(key, val);
      });
      syncThemePickers(); // Keep the color inputs in the modal matching
    } catch (e) {
      console.warn("Failed to load saved theme for this month");
    }
  }
  function syncThemePickers() {
    const styles = getComputedStyle(document.documentElement);

    // Helper to grab and trim CSS variables
    const getVar = (name) => styles.getPropertyValue(name).trim();

    document.getElementById('p-outer').value = getVar('--outer-bg');
    document.getElementById('p-inner').value = getVar('--inner-bg');
    document.getElementById('p-tile').value = getVar('--tile-bg');
    document.getElementById('p-text').value = getVar('--text-primary');
    
    // Class Backgrounds & Text
    document.getElementById('p-starter').value = getVar('--c-starter');
    document.getElementById('pt-starter').value = getVar('--t-starter');
    
    document.getElementById('p-foundation').value = getVar('--c-foundation');
    document.getElementById('pt-foundation').value = getVar('--t-foundation');

    document.getElementById('p-signature').value = getVar('--c-signature');
    document.getElementById('pt-signature').value = getVar('--t-signature');

    document.getElementById('p-focus').value = getVar('--c-focus');
    document.getElementById('pt-focus').value = getVar('--t-focus');

    document.getElementById('p-power').value = getVar('--c-power');
    document.getElementById('pt-power').value = getVar('--t-power');

    document.getElementById('p-adv').value = getVar('--c-advanced');
    document.getElementById('pt-adv').value = getVar('--t-advanced');
  }
    
  function openThemeModal() { document.getElementById('themeModal').style.display = 'flex'; }
  function closeThemeModal() { document.getElementById('themeModal').style.display = 'none'; }

  function loadPresets() {
    const container = document.getElementById('preset-grid');
    Object.keys(THEMES).forEach(name => {
      const theme = THEMES[name];
      const btn = document.createElement('div');
      btn.style = `cursor:pointer; border:1px solid ${theme.text}; background:${theme.outer}; padding:8px; text-align:center; font-size:0.6rem; color:${theme.text};`;
      btn.innerText = name;
      btn.onclick = () => applyPreset(name);
      container.appendChild(btn);
    });
  }


  // -=-=-=-=-=-=-=- End of Theme Logic -=-=-=-=-=-=-=-


  // -=-=-=-=-=-=-=- Local Storage Logic -=-=-=-=-=-=-=-
    function saveClassesToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(classData));
    }
    function loadClassOffset() {
      const saved = localStorage.getItem(CLASS_OFFSET_KEY);
      classOffset = saved ? parseInt(saved) : 0;
    }

    function saveClassOffset(val) {
      classOffset = val;
      localStorage.setItem(CLASS_OFFSET_KEY, val);
    }

    function loadClassesFromStorage() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          classData = JSON.parse(saved);
          recalculateClassCounts(); // ensure counts stay correct
        } catch (e) {
          console.error("Failed to load saved classes", e);
          classData = [];
        }
      }
    }

    function loadInstructors() {
      const data = localStorage.getItem(INSTRUCTOR_KEY);
      savedInstructors = data ? JSON.parse(data) : [];
    }

    function saveInstructors() {
      localStorage.setItem(INSTRUCTOR_KEY, JSON.stringify(savedInstructors));
    }
    // -=-=-=-=-=-=-=- End of Local Storage Logic -=-=-=-=-=-=-=-

    // -=-=-=-=-=-=-=- Import / Export Data Logic -=-=-=-=-=-=-=-
    function exportData() {
      // 1. Gather all related data from localStorage
      const backup = {
        classes: JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"),
        instructors: JSON.parse(localStorage.getItem(INSTRUCTOR_KEY) || "[]"),
        offset: localStorage.getItem(CLASS_OFFSET_KEY) || "0",
        themes: {}
      };

      // 2. Loop through localStorage to find all monthly themes
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("calendarTheme_")) {
          backup.themes[key] = JSON.parse(localStorage.getItem(key));
        }
      }

      // 3. Create the file and trigger download
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backup, null, 2));
      const downloadAnchorNode = document.createElement('a');
      downloadAnchorNode.setAttribute("href", dataStr);
      downloadAnchorNode.setAttribute("download", `class_calendar_backup_${new Date().toISOString().slice(0, 10)}.json`);
      document.body.appendChild(downloadAnchorNode);
      downloadAnchorNode.click();
      downloadAnchorNode.remove();
    }

    function importData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (confirm("This will overwrite your current data. Are you sure?")) {
            // Restore main data
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data.classes || []));
            localStorage.setItem(INSTRUCTOR_KEY, JSON.stringify(data.instructors || []));
            localStorage.setItem(CLASS_OFFSET_KEY, data.offset || "0");

            // Restore all monthly themes
            if (data.themes) {
              Object.entries(data.themes).forEach(([key, val]) => {
                localStorage.setItem(key, JSON.stringify(val));
              });
            }

            alert("Data imported successfully! Refreshing page...");
            location.reload(); // Refresh to apply all new settings
          }
        } catch (err) {
          alert("Error parsing the file. Please make sure it's a valid calendar backup.");
          console.error(err);
        }
      };
      reader.readAsText(file);
    }
    // -=-=-=-=-=-=-=- End of Import / Export Data Logic -=-=-=-=-=-=-=-

    // -=-=-=-=-=-=-=- Toggle Drop Down Logic -=-=-=-=-=-=-=- 
    function toggleDropdown() {
      const container = document.querySelector('.dropdown');
      const menu = document.getElementById("actionsMenu");
      
      // Toggle the classes
      menu.classList.toggle("show");
      container.classList.toggle("open");
    }

    // Close the dropdown if the user clicks anywhere else
    window.onclick = function(event) {
      if (!event.target.matches('.dropdown-toggle')) {
        const dropdowns = document.getElementsByClassName("dropdown-content");
        const containers = document.getElementsByClassName("dropdown");
        
        for (let i = 0; i < dropdowns.length; i++) {
          dropdowns[i].classList.remove('show');
        }
        for (let i = 0; i < containers.length; i++) {
          containers[i].classList.remove('open');
        }
      }
    }
    // -=-=-=-=-=-=-=- End of Toggle Drop Down Logic -=-=-=-=-=-=-=-


    // -=-=-=-=-=-=-=- Instructor AutoComplete Logic -=-=-=-=-=-=-=-
    function renderInstructorList(filter = "") {
      const list = document.getElementById("instructor-list");
      list.innerHTML = "";

      const matches = savedInstructors
        .filter(name => name.toLowerCase().includes(filter.toLowerCase()));

      if (!matches.length) {
        list.style.display = "none";
        return;
      }

      matches.forEach(name => {
        const row = document.createElement("div");
        row.style = `
        display:flex;
        justify-content:space-between;
        padding:6px 8px;
        cursor:pointer;
        font-size:0.7rem;
      `;

        row.innerHTML = `
        <span>${name}</span>
        <span style="color:var(--danger); cursor:pointer;">‚úï</span>
      `;

        // select instructor
        row.children[0].onclick = () => {
          document.getElementById("m-instructor").value = name;
          list.style.display = "none";
        };

        // delete instructor
        row.children[1].onclick = (e) => {
          e.stopPropagation();
          savedInstructors = savedInstructors.filter(i => i !== name);
          saveInstructors();
          renderInstructorList(filter);
        };

        list.appendChild(row);
      });

      list.style.display = "block";
    }

    const instructorInput = document.getElementById("m-instructor");

    instructorInput.addEventListener("input", e => {
      renderInstructorList(e.target.value);
    });

    instructorInput.addEventListener("focus", () => {
      renderInstructorList(instructorInput.value);
    });

    document.addEventListener("click", e => {
      if (!e.target.closest("#m-instructor")) {
        document.getElementById("instructor-list").style.display = "none";
      }
    });


    // -=-=-=-=-=-=-=- End of Instructor AutoComplete Logic -=-=-=-=-=-=-=-


    // -=-=-=-=-=-=-=- Calendar Logic -=-=-=-=-=-=-=-
    function changeDate() {
      currentMonth = parseInt(document.getElementById('view-month').value);
      currentYear = parseInt(document.getElementById('view-year').value);
      document.getElementById('display-month').innerText = months[currentMonth];
      loadThemeFromStorage();
      renderCalendar();
    }

    function renderCalendar() {
      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';
      ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(l => grid.insertAdjacentHTML('beforeend', `<div class="weekday-label">${l}</div>`));
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const mDaySelect = document.getElementById('m-day');
      mDaySelect.innerHTML = '';
      for (let i = 1; i <= daysInMonth; i++) mDaySelect.insertAdjacentHTML('beforeend', `<option value="${i}">${i}</option>`);
      for (let i = 0; i < firstDay; i++) grid.insertAdjacentHTML('beforeend', `<div class="day"></div>`);
      for (let d = 1; d <= daysInMonth; d++) {
        const schedule = classData.find(item => item.day === d && item.month === currentMonth && item.year === currentYear);
        let content = `<div class="date-num">${d}</div>`;
        if (schedule) {
          const themeBadges = (schedule.themes || []).map(t =>
            `<div class="theme-badge">${t}</div>`
          ).join('');
          const focuses = [schedule.focus1, schedule.focus2, schedule.focus3].filter(f => f).join('<br>');

          // Logic to only show the number if it's 10, 20, 30, etc.
          const showNumber = (schedule.classCount % 10 === 0) ?
            `<div class="class-number">#${schedule.classCount}</div>` : '';

          content += `
        <div class="details">${schedule.instructor}<br>${formatTime(schedule.startTime)}</div>
        <div class="box ${schedule.className}">
          <div class="title">${schedule.className}</div>
          <div class="focus-text">${focuses}</div>
          <div class="theme-badges">${themeBadges}</div>
          ${showNumber}
        </div>`;
        }
        grid.insertAdjacentHTML('beforeend', `<div class="day active" onclick="${schedule ? `openEditModal(${schedule.id})` : `openAddModal(${d})`}">${content}</div>`);
      }
      updateOverallCount();
    }
    function formatTime(t) { let [h, m] = t.split(':'); let ampm = h >= 12 ? 'pm' : 'am'; h = h % 12 || 12; return `${h}:${m} ${ampm}`; }

    // -=-=-=-=-=-=-=- End of Calendar Logic -=-=-=-=-=-=-=-



    // -=-=-=-=-=-=-=- Class Counting Logic -=-=-=-=-=-=-=-

    function recalculateClassCounts() {
      classData.sort((a, b) => {
        if (a.year !== b.year) return a.year - b.year;
        if (a.month !== b.month) return a.month - b.month;
        if (a.day !== b.day) return a.day - b.day;
        return a.startTime.localeCompare(b.startTime);
      });

      classData.forEach((item, index) => {
        item.classCount = classOffset + index + 1;
      });
    }
    
    function getCompletedClassCount() {
      const now = new Date();
      const completedInCalendar = classData.filter(item => {
        const [h, m] = item.endTime.split(':').map(Number);
        const end = new Date(item.year, item.month, item.day, h, m);
        return end <= now;
      }).length;

      return classOffset + completedInCalendar;
    }

    function updateOverallCount() {
      const completed = getCompletedClassCount();
      document.getElementById("overall-count").innerText =
        `Classes Completed: ${completed}`;
    }

    function openClassOffsetPrompt() {
      const val = prompt(
        "Enter the total number of classes you have already completed:",
        classOffset || ""
      );

      if (val === null) return;

      const num = parseInt(val);
      if (isNaN(num) || num < 0) {
        alert("Please enter a valid number.");
        return;
      }

      saveClassOffset(num);
      recalculateClassCounts();
      renderCalendar();
    }


    // -=-=-=-=-=-=-=- End of Class Counting Logic -=-=-=-=-=-=-=-

   // -=-=-=-=-=-=-=- Modal Logic -=-=-=-=-=-=-=-
    function openAddModal(d) {
      document.getElementById('classForm').reset();
      document.getElementById('edit-id').value = "";
      document.getElementById('deleteBtn').style.display = "none";
      document.getElementById('m-class-num').value = `#${classOffset + classData.length + 1}`;
      if (d) document.getElementById('m-day').value = d;
      document.getElementById('modalOverlay').style.display = 'flex';
      document.querySelectorAll('.theme-check').forEach(cb => cb.checked = false);
      document.getElementById('m-theme-notes').value = "";
    }

    function openEditModal(id) {
      const item = classData.find(i => i.id == id);
      document.querySelectorAll('.theme-check').forEach(cb => {
        cb.checked = item.themes?.includes(cb.value) || false;
      });
      document.getElementById('m-class-num').value = `#${item.classCount}`;
      document.getElementById('deleteBtn').style.display = "block";
      document.getElementById('edit-id').value = item.id;
      document.getElementById('m-day').value = item.day;
      document.getElementById('m-instructor').value = item.instructor;
      document.getElementById('m-name').value = item.className;
      document.getElementById('m-start').value = item.startTime;
      document.getElementById('m-end').value = item.endTime;
      document.getElementById('f1').value = item.focus1;
      document.getElementById('f2').value = item.focus2;
      document.getElementById('f3').value = item.focus3;
      document.getElementById('modalOverlay').style.display = 'flex';
      document.getElementById('m-theme-notes').value = item.themeNotes || "";
    }

    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
    

    // Update your Form Submit to trigger the recalculation
    document.getElementById('classForm').onsubmit = function (e) {
      e.preventDefault();

      const selectedThemes = Array.from(
        document.querySelectorAll('.theme-check:checked')
      ).map(cb => cb.value);

      const id = document.getElementById('edit-id').value;
      const entry = {
        id: id ? parseInt(id) : Date.now(),
        day: parseInt(document.getElementById('m-day').value),
        month: currentMonth,
        year: currentYear,
        instructor: document.getElementById('m-instructor').value,
        startTime: document.getElementById('m-start').value,
        endTime: document.getElementById('m-end').value,
        className: document.getElementById('m-name').value,
        focus1: document.getElementById('f1').value,
        focus2: document.getElementById('f2').value,
        focus3: document.getElementById('f3').value,
        themes: selectedThemes,
        themeNotes: document.getElementById('m-theme-notes').value.trim(),
        // classCount will be added by recalculate function
      };

      if (id) {
        classData = classData.map(item => item.id == id ? entry : item);
      } else {
        classData.push(entry);
      }
      const instructorName = document.getElementById('m-instructor').value.trim();

      if (instructorName && !savedInstructors.includes(instructorName)) {
        savedInstructors.push(instructorName);
        saveInstructors();
      }

      recalculateClassCounts(); // Run the calculation
      saveClassesToStorage();
      closeModal();
      renderCalendar();
    };

    // Also update deleteEntry to recalculate
    function deleteEntry() {
      classData = classData.filter(i => i.id != document.getElementById('edit-id').value);
      recalculateClassCounts(); // Run calculation so numbers shift up
      saveClassesToStorage();
      closeModal();
      renderCalendar();
      updateOverallCount();
    }

    
    function autoFillEndTime() {
      const startTimeVal = document.getElementById('m-start').value;
      const className = document.getElementById('m-name').value;

      // Look up duration from our map. Default to 50 if not found.
      const durationMinutes = CLASS_CONFIG[className] || 50;

      if (!startTimeVal) return;

      // Split start time (HH:mm)
      const [hours, minutes] = startTimeVal.split(':').map(Number);

      // Create a date object to perform the math
      const date = new Date();
      date.setHours(hours);
      date.setMinutes(minutes + durationMinutes);

      // Format back to 24hr string for the time picker
      const endHours = String(date.getHours()).padStart(2, '0');
      const endMinutes = String(date.getMinutes()).padStart(2, '0');

      document.getElementById('m-end').value = `${endHours}:${endMinutes}`;
    }
    // -=-=-=-=-=-=-=- End of Modal Logic -=-=-=-=-=-=-=-

    // -=-=-=-=-=-=-=- Init Logic -=-=-=-=-=-=-=-
    
    function init() {

      loadThemeFromStorage();
      loadClassesFromStorage();
      loadClassOffset();
      loadInstructors();
      recalculateClassCounts();

      

      const monthSelect = document.getElementById('view-month');
      const yearSelect = document.getElementById('view-year');
      months.forEach((m, i) => monthSelect.insertAdjacentHTML('beforeend', `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${m}</option>`));
      for (let y = currentYear - 1; y <= currentYear + 3; y++) yearSelect.insertAdjacentHTML('beforeend', `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`);

      const focusOptions = `<option value="">None</option><optgroup label="Lower Body"><option>Center Glutes</option><option>Outer Glutes</option><option>Inner Thighs</option><option>Hamstrings</option><option>Leg Wrap</option></optgroup><optgroup label="Upper Body"><option>Back</option><option>Shoulders</option><option>Biceps</option><option>Triceps</option><option>Chest</option><option>Arm Wrap</option></optgroup><optgroup label="Core"><option>Core Obliques</option><option>Core</option><option>Obliques</option></optgroup>`;
      document.getElementById('focus-container').innerHTML = `<select id="f1">${focusOptions}</select><select id="f2">${focusOptions}</select><select id="f3">${focusOptions}</select>`;

      document.getElementById('m-start').addEventListener('input', autoFillEndTime);
      document.getElementById('m-name').addEventListener('change', autoFillEndTime);
      changeDate();
      loadPresets();
      // Set initial picker values to match CSS defaults
      document.getElementById('p-outer').value = "#4a6741";
      document.getElementById('p-inner').value = "#0b2612";
      document.getElementById('p-tile').value = "#1c3d25";
      document.getElementById('p-text').value = "#75a478";
      document.getElementById('p-starter').value = "#78a2cc";
      document.getElementById('p-foundation').value = "#a2cc78";
      document.getElementById('p-signature').value = "#75a478";
      document.getElementById('p-focus').value = "#ccae78";
      document.getElementById('p-power').value = "#cc7878";
      document.getElementById('p-adv').value = "#b378cc";
      syncThemePickers();
  
    }

    // -=-=-=-=-=-=-=- End of Init Logic -=-=-=-=-=-=-=-

    init();
  </script>
</body>

</html>