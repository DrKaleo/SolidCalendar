<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <style>
    /* These variables are now controlled by the Theme Modal */
    :root {
      --outer-bg: #4a6741;
      --inner-bg: #0b2612;
      --tile-bg: #1c3d25;
      --text-primary: #75a478;
      --danger: #8b2e2e;
      --grid-gap: 8px;

      /* Class Type Colors */
      --c-starter: #78a2cc;
      --c-foundation: #a2cc78;
      --c-signature: #75a478;
      --c-focus: #ccae78;
      --c-power: #cc7878;
      --c-advanced: #b378cc;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--outer-bg);
      font-family: 'Georgia', serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh;
    }

    .controls {
      width: 100%;
      max-width: 850px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .selectors {
      display: flex;
      gap: 10px;
    }

    select.nav-select,
    .theme-btn {
      background: var(--inner-bg);
      color: var(--text-primary);
      border: 1px solid var(--text-primary);
      padding: 5px 10px;
      font-family: 'Georgia', serif;
      cursor: pointer;
    }

    .add-btn {
      background-color: var(--tile-bg);
      color: var(--text-primary);
      border: 1px solid var(--text-primary);
      padding: 10px 20px;
      cursor: pointer;
    }

    .calendar-container {
      width: 100%;
      max-width: 850px;
      background-color: var(--inner-bg);
      padding: 20px;
    }
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-top: 12px;
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin-bottom: 10px;
      color: var(--text-primary);
    }

    .header h1 {
      font-size: 2.2rem;
      font-weight: normal;
      text-transform: uppercase;
    }

    .line {
      height: 1px;
      background-color: var(--text-primary);
      flex-grow: 1;
    }

    .main-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: var(--grid-gap);
    }

    .weekday-label {
      color: var(--text-primary);
      font-size: 1.8rem;
      text-align: center;
      padding: 10px 0;
    }

    /* .day {
      aspect-ratio: 1 / 1;
      position: relative;
      background-color: transparent;
      color: var(--text-primary);
      overflow: hidden;
    } */
    .day {
      background: var(--inner-bg);
      border: 1px solid color-mix(in srgb, var(--text-primary) 20%, transparent);
      border-radius: 12px;
      min-height: 120px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .day-header {
      font-size: 0.65rem;
      letter-spacing: 1px;
      opacity: 0.7;
      text-align: right;
    }
    .class-entry {
      background: var(--tile-bg);
      border-radius: 10px;
      padding: 8px 8px 14px;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 4px;
      box-shadow:
        0 1px 2px rgba(0,0,0,0.2),
        inset 0 0 0 1px rgba(255,255,255,0.04);
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }
    .class-entry:hover {
      transform: translateY(-2px);
      box-shadow:
        0 4px 10px rgba(0,0,0,0.35),
        inset 0 0 0 1px rgba(255,255,255,0.06);
    }
    .class-entry .title {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .class-entry .details {
      font-size: 0.6rem;
      opacity: 0.85;
      line-height: 1.3;
    }
    .focus-text {
      font-size: 0.55rem;
      opacity: 0.75;
      line-height: 1.2;
    }

    .day.active {
      background-color: var(--tile-bg);
      padding: 5px;
      cursor: pointer;
      transition: 0.1s;
      border: 1px solid transparent;
    }

    .day.active:hover {
      transform: scale(1.02);
      z-index: 5;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      border-color: var(--text-primary);
    }

    .date-num {
      position: absolute;
      top: 2px;
      right: 5px;
      font-size: 1.1rem;
      font-family: Arial, sans-serif;
    }

    .details {
      font-size: 0.6rem;
      font-family: Arial, sans-serif;
      line-height: 1.1;
      margin-top: 2px;
    }

    .box {
      border: 1px solid var(--text-primary);
      margin-top: 4px;
      padding: 2px;
      text-align: center;
      height: 60%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .box.Starter50 {
      border-color: var(--c-starter);
      color: var(--c-starter);
    }

    .box.Foundation50 {
      border-color: var(--c-foundation);
      color: var(--c-foundation);
    }

    .box.Focus50 {
      border-color: var(--c-focus);
      color: var(--c-focus);
    }

    .box.Power30 {
      border-color: var(--c-power);
      color: var(--c-power);
    }

    .box.Advanced50,
    .box.Advanced65 {
      border-color: var(--c-advanced);
      color: var(--c-advanced);
    }

    .title {
      font-weight: bold;
      font-size: 0.55rem;
      text-transform: uppercase;
    }

    /* .focus-text {
      font-size: 0.45rem;
      margin-top: 1px;
      line-height: 1;
      opacity: 0.9;
    } */

    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background-color: var(--inner-bg);
      border: 2px solid var(--text-primary);
      padding: 25px;
      min-width: 480px;
      color: var(--text-primary);
    }

    .form-group {
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-size: 0.7rem;
      margin-bottom: 3px;
      text-transform: uppercase;
      opacity: 0.8;
    }

    .form-group input,
    .form-group select {
      background: var(--tile-bg);
      border: 1px solid var(--text-primary);
      color: var(--text-primary);
      padding: 8px;
    }

    .color-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .color-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
    }

    .color-item input {
      width: 40px;
      height: 30px;
      border: 1px solid var(--text-primary);
      cursor: pointer;
      background: none;
      padding: 0;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .modal-actions button {
      flex: 1;
      padding: 12px;
      cursor: pointer;
      border: 1px solid var(--text-primary);
      font-family: 'Georgia', serif;
    }

    /* .theme-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      margin-top: 2px;
    } */
    .theme-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }
    .theme-badge {
      font-size: 0.42rem;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--text-primary);
      opacity: 0.85;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    /* .theme-badge {
      font-size: 0.42rem;
      padding: 1px 4px;
      border: 1px solid var(--text-primary);
      opacity: 0.9;
      text-transform: uppercase;
      white-space: nowrap;
    } */

    .class-number {
      position: absolute;
      bottom: 6px;
      right: 8px;
      font-size: 0.55rem;
      font-weight: 600;
      opacity: 0.6;
    }
    .day.today {
      outline: 2px solid var(--text-primary);
      outline-offset: 2px;
    }
  </style>
</head>

<body>

  <div class="controls">
    <div class="selectors">
      <select id="view-month" class="nav-select" onchange="changeDate()"></select>
      <select id="view-year" class="nav-select" onchange="changeDate()"></select>
      <button class="theme-btn" onclick="openClassOffsetPrompt()">üèÅ Set Lifetime Count</button>
      <button class="theme-btn" onclick="openThemeModal()">üé® Theme</button>
    </div>
    <button class="add-btn" onclick="openAddModal()">+ Add New Class</button>
  </div>

  <div class="calendar-container">
    <div class="header">
      <div class="line"></div>
      <h1 id="display-month">JANUARY</h1>
      <div id="overall-count" style="
      font-size: 0.75rem;
      opacity: 0.85;
      letter-spacing: 1px;
    ">
        Classes Completed: 0
      </div>
      <div class="line"></div>
    </div>
    <div id="calendar-grid" class="main-grid"></div>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal-content">
      <h2 id="modalTitle" style="margin-bottom:15px; font-weight:normal;">Add New Class</h2>
      <form id="classForm">
        <input type="hidden" id="edit-id">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
          <div class="form-group"><label>Day</label><select id="m-day" required></select></div>
          <div class="form-group">
            <label>Class Type</label>
            <select id="m-name">
              <option value="Starter50">Starter50</option>
              <option value="Foundation50">Foundation50</option>
              <option value="Signature50" selected>Signature50</option>
              <option value="Focus50">Focus50</option>
              <option value="Power30">Power30</option>
              <option value="Advanced50">Advanced50</option>
              <option value="Advanced65">Advanced65</option>
            </select>
          </div>
        </div>
        <div class="form-group" style="position:relative;">
          <label>Instructor</label>
          <input type="text" id="m-instructor" autocomplete="off" required>
          <div id="instructor-list" style="
          position:absolute;
          top:100%;
          left:0;
          right:0;
          background:var(--inner-bg);
          border:1px solid var(--text-primary);
          display:none;
          z-index:1001;
          max-height:150px;
          overflow-y:auto;
        "></div>
        </div>
        <div class="form-group">
          <label>Class Number (Auto-calculated)</label>
          <input type="text" id="m-class-num" readonly style="opacity: 0.6; cursor: not-allowed;"
            placeholder="Calculated on save...">
        </div>
        <div class="form-group"><label>Muscle Focuses</label>
          <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px;" id="focus-container"></div>
        </div>
        <div class="form-group">
          <label>Class Themes</label>
          <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:6px;">
            <label><input type="checkbox" value="Music" class="theme-check"> Music</label>
            <label><input type="checkbox" value="Giveaway" class="theme-check"> Giveaway</label>
            <label><input type="checkbox" value="Pop Up" class="theme-check"> Pop Up</label>
            <label><input type="checkbox" value="Event" class="theme-check"> Event</label>
            <label><input type="checkbox" value="Team Teach" class="theme-check"> Team Teach</label>
            <label><input type="checkbox" value="Other" class="theme-check"> Other</label>
          </div>
        </div>
        <div class="form-group">
          <label>Theme Notes</label>
          <textarea id="m-theme-notes" rows="3"
            style="resize:none; background:var(--tile-bg); border:1px solid var(--text-primary); color:var(--text-primary);">
        </textarea>
        </div>
        <div style="display:flex; gap:10px;">
          <div class="form-group" style="flex:1;"><label>Start Time</label><input type="time" id="m-start" required>
          </div>
          <div class="form-group" style="flex:1;"><label>End Time</label><input type="time" id="m-end" required></div>
        </div>
        <div class="modal-actions">
          <button type="button" style="background:#8b2e2e; color:white; border:none; display:none;" id="deleteBtn"
            onclick="deleteEntry()">Delete</button>
          <button type="button" style="background:transparent; color:var(--text-primary)"
            onclick="closeModal()">Cancel</button>
          <button type="submit" style="background:var(--text-primary); color:var(--inner-bg); font-weight:bold;">Save
            Class</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal-overlay" id="themeModal">
    <div class="modal-content" style="width: 550px; max-height: 90vh; overflow-y: auto;">
      <h2 style="margin-bottom:15px; font-weight:normal;">Customize Theme</h2>

      <label
        style="font-size: 0.7rem; text-transform: uppercase; opacity: 0.8; display: block; margin-bottom: 10px;">Preset
        Themes</label>
      <div id="preset-grid"
        style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 25px;">
      </div>

      <label
        style="font-size: 0.7rem; text-transform: uppercase; opacity: 0.8; display: block; margin-bottom: 10px;">Custom
        Colors</label>
      <div class="color-grid">
        <div class="color-item"><input type="color" id="p-outer"
            oninput="uiTheme('--outer-bg', this.value)"><label>Outer BG</label></div>
        <div class="color-item"><input type="color" id="p-inner"
            oninput="uiTheme('--inner-bg', this.value)"><label>Inner BG</label></div>
        <div class="color-item"><input type="color" id="p-tile" oninput="uiTheme('--tile-bg', this.value)"><label>Empty
            Tile</label></div>
        <div class="color-item"><input type="color" id="p-text"
            oninput="uiTheme('--text-primary', this.value)"><label>Text/Accents</label></div>

        <div style="grid-column: 1 / -1; height: 1px; background: var(--text-primary); opacity: 0.3; margin: 10px 0;">
        </div>

        <div class="color-item"><input type="color" id="p-starter"
            oninput="uiTheme('--c-starter', this.value)"><label>Starter</label></div>
        <div class="color-item"><input type="color" id="p-foundation"
            oninput="uiTheme('--c-foundation', this.value)"><label>Foundation</label></div>
        <div class="color-item"><input type="color" id="p-signature"
            oninput="uiTheme('--c-signature', this.value)"><label>Signature</label></div>
        <div class="color-item"><input type="color" id="p-focus"
            oninput="uiTheme('--c-focus', this.value)"><label>Focus</label></div>
        <div class="color-item"><input type="color" id="p-power"
            oninput="uiTheme('--c-power', this.value)"><label>Power</label></div>
        <div class="color-item"><input type="color" id="p-adv"
            oninput="uiTheme('--c-advanced', this.value)"><label>Advanced</label></div>
      </div>

      <div class="modal-actions">
        <button type="button" style="background:var(--text-primary); color:var(--inner-bg); font-weight:bold;"
          onclick="closeThemeModal()">Done</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "classCalendarData_v1";
const INSTRUCTOR_KEY = "savedInstructors_v1";
const CLASS_OFFSET_KEY = "lifetimeClassOffset_v1";
const THEME_STORAGE_KEY = "calendarTheme_v1";

const THEME_VARS = [
  "--outer-bg",
  "--inner-bg",
  "--tile-bg",
  "--text-primary",
  "--c-starter",
  "--c-foundation",
  "--c-signature",
  "--c-focus",
  "--c-power",
  "--c-advanced"
];

const CLASS_CONFIG = {
  "Starter50": 50,
  "Foundation50": 50,
  "Signature50": 50,
  "Focus50": 50,
  "Power30": 30,
  "Advanced50": 50,
  "Advanced65": 65
};

const months = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

let classData = [];
let savedInstructors = [];
let classOffset = 0;

let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();

// -=-=-=-=-=-=-=- Theme Logic -=-=-=-=-=-=-=-
  function uiTheme(variable, val) {
    document.documentElement.style.setProperty(variable, val);
    saveThemeToStorage();
  }

  function applyPreset(name) {
    const t = THEMES[name];
    uiTheme('--outer-bg', t.outer);
    uiTheme('--inner-bg', t.inner);
    uiTheme('--tile-bg', t.tile);
    uiTheme('--text-primary', t.text);

    // Sync pickers
    document.getElementById('p-outer').value = t.outer;
    document.getElementById('p-inner').value = t.inner;
    document.getElementById('p-tile').value = t.tile;
    document.getElementById('p-text').value = t.text;
  }

  function saveThemeToStorage() {
    const theme = {};
    const styles = getComputedStyle(document.documentElement);

    THEME_VARS.forEach(v => {
      theme[v] = styles.getPropertyValue(v).trim();
    });

    localStorage.setItem(THEME_STORAGE_KEY, JSON.stringify(theme));
  }

  function loadThemeFromStorage() {
    const saved = localStorage.getItem(THEME_STORAGE_KEY);
    if (!saved) return;

    try {
      const theme = JSON.parse(saved);
      Object.entries(theme).forEach(([key, val]) => {
        document.documentElement.style.setProperty(key, val);
      });
    } catch (e) {
      console.warn("Failed to load saved theme");
    }
  }
  function syncThemePickers() {
    const styles = getComputedStyle(document.documentElement);

    document.getElementById('p-outer').value = styles.getPropertyValue('--outer-bg').trim();
    document.getElementById('p-inner').value = styles.getPropertyValue('--inner-bg').trim();
    document.getElementById('p-tile').value = styles.getPropertyValue('--tile-bg').trim();
    document.getElementById('p-text').value = styles.getPropertyValue('--text-primary').trim();

    document.getElementById('p-starter').value = styles.getPropertyValue('--c-starter').trim();
    document.getElementById('p-foundation').value = styles.getPropertyValue('--c-foundation').trim();
    document.getElementById('p-signature').value = styles.getPropertyValue('--c-signature').trim();
    document.getElementById('p-focus').value = styles.getPropertyValue('--c-focus').trim();
    document.getElementById('p-power').value = styles.getPropertyValue('--c-power').trim();
    document.getElementById('p-adv').value = styles.getPropertyValue('--c-advanced').trim();
  }
    
  function openThemeModal() { document.getElementById('themeModal').style.display = 'flex'; }
  function closeThemeModal() { document.getElementById('themeModal').style.display = 'none'; }

  function loadPresets() {
    const container = document.getElementById('preset-grid');
    Object.keys(THEMES).forEach(name => {
      const theme = THEMES[name];
      const btn = document.createElement('div');
      btn.style = `cursor:pointer; border:1px solid ${theme.text}; background:${theme.outer}; padding:8px; text-align:center; font-size:0.6rem; color:${theme.text};`;
      btn.innerText = name;
      btn.onclick = () => applyPreset(name);
      container.appendChild(btn);
    });
  }

    // Update init to call loadPresets
  const originalInit = init;
  init = function () {
    originalInit();
    loadPresets();
    // Set initial picker values to match CSS defaults
    document.getElementById('p-outer').value = "#4a6741";
    document.getElementById('p-inner').value = "#0b2612";
    document.getElementById('p-tile').value = "#1c3d25";
    document.getElementById('p-text').value = "#75a478";
    document.getElementById('p-starter').value = "#78a2cc";
    document.getElementById('p-foundation').value = "#a2cc78";
    document.getElementById('p-signature').value = "#75a478";
    document.getElementById('p-focus').value = "#ccae78";
    document.getElementById('p-power').value = "#cc7878";
    document.getElementById('p-adv').value = "#b378cc";
  };

  // -=-=-=-=-=-=-=- End of Theme Logic -=-=-=-=-=-=-=-


  // -=-=-=-=-=-=-=- Local Storage Logic -=-=-=-=-=-=-=-
    function saveClassesToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(classData));
    }
    function loadClassOffset() {
      const saved = localStorage.getItem(CLASS_OFFSET_KEY);
      classOffset = saved ? parseInt(saved) : 0;
    }

    function saveClassOffset(val) {
      classOffset = val;
      localStorage.setItem(CLASS_OFFSET_KEY, val);
    }

    function loadClassesFromStorage() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          classData = JSON.parse(saved);
          recalculateClassCounts(); // ensure counts stay correct
        } catch (e) {
          console.error("Failed to load saved classes", e);
          classData = [];
        }
      }
    }

    function loadInstructors() {
      const data = localStorage.getItem(INSTRUCTOR_KEY);
      savedInstructors = data ? JSON.parse(data) : [];
    }

    function saveInstructors() {
      localStorage.setItem(INSTRUCTOR_KEY, JSON.stringify(savedInstructors));
    }
    // -=-=-=-=-=-=-=- End of Local Storage Logic -=-=-=-=-=-=-=-


    // -=-=-=-=-=-=-=- Instructor AutoComplete Logic -=-=-=-=-=-=-=-
    function renderInstructorList(filter = "") {
      const list = document.getElementById("instructor-list");
      list.innerHTML = "";

      const matches = savedInstructors
        .filter(name => name.toLowerCase().includes(filter.toLowerCase()));

      if (!matches.length) {
        list.style.display = "none";
        return;
      }

      matches.forEach(name => {
        const row = document.createElement("div");
        row.style = `
        display:flex;
        justify-content:space-between;
        padding:6px 8px;
        cursor:pointer;
        font-size:0.7rem;
      `;

        row.innerHTML = `
        <span>${name}</span>
        <span style="color:var(--danger); cursor:pointer;">‚úï</span>
      `;

        // select instructor
        row.children[0].onclick = () => {
          document.getElementById("m-instructor").value = name;
          list.style.display = "none";
        };

        // delete instructor
        row.children[1].onclick = (e) => {
          e.stopPropagation();
          savedInstructors = savedInstructors.filter(i => i !== name);
          saveInstructors();
          renderInstructorList(filter);
        };

        list.appendChild(row);
      });

      list.style.display = "block";
    }

    const instructorInput = document.getElementById("m-instructor");

    instructorInput.addEventListener("input", e => {
      renderInstructorList(e.target.value);
    });

    instructorInput.addEventListener("focus", () => {
      renderInstructorList(instructorInput.value);
    });

    document.addEventListener("click", e => {
      if (!e.target.closest("#m-instructor")) {
        document.getElementById("instructor-list").style.display = "none";
      }
    });


    // -=-=-=-=-=-=-=- End of Instructor AutoComplete Logic -=-=-=-=-=-=-=-


    // -=-=-=-=-=-=-=- Calendar Logic -=-=-=-=-=-=-=-
    function changeDate() {
      currentMonth = parseInt(document.getElementById('view-month').value);
      currentYear = parseInt(document.getElementById('view-year').value);
      document.getElementById('display-month').innerText = months[currentMonth];
      renderCalendar();
    }

    function renderCalendar() {
      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';
      ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(l => grid.insertAdjacentHTML('beforeend', `<div class="weekday-label">${l}</div>`));
      const firstDay = new Date(currentYear, currentMonth, 1).getDay();
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const mDaySelect = document.getElementById('m-day');
      mDaySelect.innerHTML = '';
      for (let i = 1; i <= daysInMonth; i++) mDaySelect.insertAdjacentHTML('beforeend', `<option value="${i}">${i}</option>`);
      for (let i = 0; i < firstDay; i++) grid.insertAdjacentHTML('beforeend', `<div class="day"></div>`);
      for (let d = 1; d <= daysInMonth; d++) {
        const schedule = classData.find(item => item.day === d && item.month === currentMonth && item.year === currentYear);
        let content = `<div class="date-num">${d}</div>`;
        if (schedule) {
          const themeBadges = (schedule.themes || []).map(t =>
            `<div class="theme-badge">${t}</div>`
          ).join('');
          const focuses = [schedule.focus1, schedule.focus2, schedule.focus3].filter(f => f).join(' & ');

          // Logic to only show the number if it's 10, 20, 30, etc.
          const showNumber = (schedule.classCount % 5 === 0) ?
            `<div class="class-number">#${schedule.classCount}</div>` : '';

          content += `
        <div class="details">${schedule.instructor}<br>${formatTime(schedule.startTime)}</div>
        <div class="box ${schedule.className}">
          <div class="title">${schedule.className}</div>
          <div class="focus-text">${focuses}</div>
          <div class="theme-badges">${themeBadges}</div>
          ${showNumber}
        </div>`;
        }
        grid.insertAdjacentHTML('beforeend', `<div class="day active" onclick="${schedule ? `openEditModal(${schedule.id})` : `openAddModal(${d})`}">${content}</div>`);
      }
      updateOverallCount();
    }
    function formatTime(t) { let [h, m] = t.split(':'); let ampm = h >= 12 ? 'pm' : 'am'; h = h % 12 || 12; return `${h}:${m} ${ampm}`; }

    // -=-=-=-=-=-=-=- End of Calendar Logic -=-=-=-=-=-=-=-



    // -=-=-=-=-=-=-=- Class Counting Logic -=-=-=-=-=-=-=-

    function recalculateClassCounts() {
      classData.sort((a, b) => {
        if (a.year !== b.year) return a.year - b.year;
        if (a.month !== b.month) return a.month - b.month;
        if (a.day !== b.day) return a.day - b.day;
        return a.startTime.localeCompare(b.startTime);
      });

      classData.forEach((item, index) => {
        item.classCount = classOffset + index + 1;
      });
    }
    
    function getCompletedClassCount() {
      const now = new Date();
      const completedInCalendar = classData.filter(item => {
        const [h, m] = item.endTime.split(':').map(Number);
        const end = new Date(item.year, item.month, item.day, h, m);
        return end <= now;
      }).length;

      return classOffset + completedInCalendar;
    }

    function updateOverallCount() {
      const completed = getCompletedClassCount();
      document.getElementById("overall-count").innerText =
        `Classes Completed: ${completed}`;
    }

    function openClassOffsetPrompt() {
      const val = prompt(
        "Enter the total number of classes you have already completed:",
        classOffset || ""
      );

      if (val === null) return;

      const num = parseInt(val);
      if (isNaN(num) || num < 0) {
        alert("Please enter a valid number.");
        return;
      }

      saveClassOffset(num);
      recalculateClassCounts();
      renderCalendar();
    }


    // -=-=-=-=-=-=-=- End of Class Counting Logic -=-=-=-=-=-=-=-

   // -=-=-=-=-=-=-=- Modal Logic -=-=-=-=-=-=-=-
    function openAddModal(d) {
      document.getElementById('classForm').reset();
      document.getElementById('edit-id').value = "";
      document.getElementById('deleteBtn').style.display = "none";
      document.getElementById('m-class-num').value = `#${classOffset + classData.length + 1}`;
      if (d) document.getElementById('m-day').value = d;
      document.getElementById('modalOverlay').style.display = 'flex';
      document.querySelectorAll('.theme-check').forEach(cb => cb.checked = false);
      document.getElementById('m-theme-notes').value = "";
    }

    function openEditModal(id) {
      const item = classData.find(i => i.id == id);
      document.querySelectorAll('.theme-check').forEach(cb => {
        cb.checked = item.themes?.includes(cb.value) || false;
      });
      document.getElementById('m-class-num').value = `#${item.classCount}`;
      document.getElementById('deleteBtn').style.display = "block";
      document.getElementById('edit-id').value = item.id;
      document.getElementById('m-day').value = item.day;
      document.getElementById('m-instructor').value = item.instructor;
      document.getElementById('m-name').value = item.className;
      document.getElementById('m-start').value = item.startTime;
      document.getElementById('m-end').value = item.endTime;
      document.getElementById('f1').value = item.focus1;
      document.getElementById('f2').value = item.focus2;
      document.getElementById('f3').value = item.focus3;
      document.getElementById('modalOverlay').style.display = 'flex';
      document.getElementById('m-theme-notes').value = item.themeNotes || "";
    }

    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
    

    // Update your Form Submit to trigger the recalculation
    document.getElementById('classForm').onsubmit = function (e) {
      e.preventDefault();

      const selectedThemes = Array.from(
        document.querySelectorAll('.theme-check:checked')
      ).map(cb => cb.value);

      const id = document.getElementById('edit-id').value;
      const entry = {
        id: id ? parseInt(id) : Date.now(),
        day: parseInt(document.getElementById('m-day').value),
        month: currentMonth,
        year: currentYear,
        instructor: document.getElementById('m-instructor').value,
        startTime: document.getElementById('m-start').value,
        endTime: document.getElementById('m-end').value,
        className: document.getElementById('m-name').value,
        focus1: document.getElementById('f1').value,
        focus2: document.getElementById('f2').value,
        focus3: document.getElementById('f3').value,
        themes: selectedThemes,
        themeNotes: document.getElementById('m-theme-notes').value.trim(),
        // classCount will be added by recalculate function
      };

      if (id) {
        classData = classData.map(item => item.id == id ? entry : item);
      } else {
        classData.push(entry);
      }
      const instructorName = document.getElementById('m-instructor').value.trim();

      if (instructorName && !savedInstructors.includes(instructorName)) {
        savedInstructors.push(instructorName);
        saveInstructors();
      }

      recalculateClassCounts(); // Run the calculation
      saveClassesToStorage();
      closeModal();
      renderCalendar();
    };

    // Also update deleteEntry to recalculate
    function deleteEntry() {
      classData = classData.filter(i => i.id != document.getElementById('edit-id').value);
      recalculateClassCounts(); // Run calculation so numbers shift up
      saveClassesToStorage();
      closeModal();
      renderCalendar();
      updateOverallCount();
    }

    
    function autoFillEndTime() {
      const startTimeVal = document.getElementById('m-start').value;
      const className = document.getElementById('m-name').value;

      // Look up duration from our map. Default to 50 if not found.
      const durationMinutes = CLASS_CONFIG[className] || 50;

      if (!startTimeVal) return;

      // Split start time (HH:mm)
      const [hours, minutes] = startTimeVal.split(':').map(Number);

      // Create a date object to perform the math
      const date = new Date();
      date.setHours(hours);
      date.setMinutes(minutes + durationMinutes);

      // Format back to 24hr string for the time picker
      const endHours = String(date.getHours()).padStart(2, '0');
      const endMinutes = String(date.getMinutes()).padStart(2, '0');

      document.getElementById('m-end').value = `${endHours}:${endMinutes}`;
    }
    // -=-=-=-=-=-=-=- End of Modal Logic -=-=-=-=-=-=-=-

    // -=-=-=-=-=-=-=- Init Logic -=-=-=-=-=-=-=-
    
    function init() {
      loadThemeFromStorage();
      loadClassesFromStorage();
      loadClassOffset();
      loadInstructors();
      recalculateClassCounts();
      syncThemePickers();
      

      const monthSelect = document.getElementById('view-month');
      const yearSelect = document.getElementById('view-year');
      months.forEach((m, i) => monthSelect.insertAdjacentHTML('beforeend', `<option value="${i}" ${i === currentMonth ? 'selected' : ''}>${m}</option>`));
      for (let y = currentYear - 1; y <= currentYear + 3; y++) yearSelect.insertAdjacentHTML('beforeend', `<option value="${y}" ${y === currentYear ? 'selected' : ''}>${y}</option>`);

      const focusOptions = `<option value="">None</option><optgroup label="Lower Body"><option>Center Glutes</option><option>Outer Glutes</option><option>Inner Thighs</option><option>Hamstrings</option><option>Leg Wrap</option></optgroup><optgroup label="Upper Body"><option>Back</option><option>Shoulders</option><option>Biceps</option><option>Triceps</option><option>Chest</option><option>Arm Wrap</option></optgroup><optgroup label="Core"><option>Core & Obliques</option><option>Core</option><option>Obliques</option></optgroup>`;
      document.getElementById('focus-container').innerHTML = `<select id="f1">${focusOptions}</select><select id="f2">${focusOptions}</select><select id="f3">${focusOptions}</select>`;

      document.getElementById('m-start').addEventListener('input', autoFillEndTime);
      document.getElementById('m-name').addEventListener('change', autoFillEndTime);
      changeDate();
    }

    // -=-=-=-=-=-=-=- End of Init Logic -=-=-=-=-=-=-=-

    init();
  </script>
</body>

</html>